# M5 - Package to manage users and privileges (master)
---
## Оглавление

  - [Ссылки](#link1)
  - [Введение](#link2)
	- [Общее описание работы пакета](#link3)
	- [Функционал](#link4)
	- [Схемы взаимодействий с другими пакетами](#link5)
	- [Транс-пакетные связи](#link6)
	- [Кэширование](#link7)
  - [Заметки к релизам](#link100)

---

## Ссылки <a id="link1"></a>
```

  > Адрес репозитория пакета M5 на github
      https://github.com/4gekkman/m5

	
			
```

## Введение <a id="link2"></a>
```

  ● Это М-пакет для управления пользователями, группами и правами.
  ● Права могут быть:
    - На доступ к документам D-пакетов.
    - На выполнение команд.
    - Кастомные права.


```
## Общее описание работы пакета <a id="link3"></a>
```
  --- Оглавление

    # Пользователи
    # Администраторы
    # Анонимный пользователь
    # Группы
    # Права
    # Теги
    # Автопометка автоматических прав тегами
    # Обновление состава формируемых автоматических прав
    # Механизм автоприсвоения прав
    # Выключатель системы проверки автоматически прав
    # Ограничение на минимальное кол-во символов в пароле
    # Механизм восстановления пароля
    # Защита от брутфорса
    # Настройка времени жизни аутентификационной куки
    # Настройка переадресации после входа
    # Настройка столбцов, которые можно использовать в качестве логина
    # Настройка факторов и сценариев аутентификации
    # Настройка SMS-аутентификации
    # Настройка аутентификации через секретную фразу
    #

  ---

  # Пользователи
    - Эта сущность нужна для персонализации пользователей приложения.
    - Чтобы при каждом визите пользователя приложение его узнавало.

  # Администраторы
    - Администратором является пользователь в группе с флагом "администраторы".
    - В системе может быть только 1 группа с флагом "администраторы".
    - Если таковой группы нет, то значит в системе нет администраторов.

  # Анонимный пользователь
    - Анонимными называют не аутентифицированных пользователей.
    - В системе может быть лишь 1 пользователь с флагом "анонимный".
    - Если такового нет, то анонимные пользователи не имеют никаких прав.

  # Группы
    - Каждый пользователь может состоять в любом количестве групп.
    - Группы облегчают организацию воздействия на массы пользователей.

  # Права
    - Общий принцип такой: всё, что явно не разрешено, запрещено.
    - Права могут быть присвоены как пользователям, так и группам.
    - Итоговый набор прав формируется, как сумма личных прав пользователя,
      и прав всех тех групп, в которых он состоит.
    - Бывают 3 типа прав:

      1) access    | На доступ к интерфейсам D,L,W-пакетов.
        - Формируются системой автоматически.
        - Получают имя по шаблону: access_[ID D,L,W-пакета]
        - Реализуются в before middleware пакета M5.

      2) exec      | На выполнение команд.
        - Формируются системой автоматически.
        - Получают имя по шаблону: exec_[ID M-пакета]_[ID команды]
        - Реализуются в хелпере runcommand.

      3) custom    | Кастомные права.
        - Формируются пользователем вручную.
        - Получают имя по шаблону: custom_[любая строка]
        - Стандарты по реализации этих прав отсутствуют.

    - Инфу о пакетах и командах, необходимую для автоматического
      формирования соответствующих прав, пакет получает транс-пакетные
      связи с пакетами M1 и M4.

  # Теги
    - Правам, пользователям и группам могут присваиваться теги.
    - Один тег может быть присвоен и тем, и другим и третьим.
    - Теги помогают находить и воздействовать на наборы сущностей.
    - Кроме того, они задействованы в механизме автоприсвоения прав.

  # Автопометка автоматических прав тегами
    - Права типов exec и access автоматически помечаются тегами при создании.
    - А именно, тегами принадлежности к тому или ному пакету.
    - Примеры: 'm1', 'd5', 'l3'.

  # Обновление состава формируемых автоматических прав
    - Все права типов access и exex формируются исплючительно автоматически.
    - Первые формируются на основе данных из базы пакета M1.
    - Вторые формируются на основе данных из базы пакета M4.
    - Соответствующие данные приложение извлекает через транс-пакетные связи.
    - При любом обновлении баз M1/M4 необходимо обновлять все авто-права в M5.
    - Поэтому, в M5 обработчик ловит события "m1:afterupdate" и "m4:afterupdate".
    - Эти события являются уведомлениями от M1/M4 об очередном обновлении базы.
    - И запускает команду обновления C1_update.
    - В ней все существующие автоматические права мяго удаляются.
    - Затем данные извлекаются из M1/M4 через транс-пакетные связи.
    - И восстанавливается или создаётся полный набор access и exec прав.

  # Механизм автоприсвоения прав
    - Команда C1_update также запускается при любом изменении в с custom-правами.
    - Код механзма автоприсвоения находится в C1_update, после кода обновления.
    - У прав и пользователей/групп могут быть общие теги.
    - Пользователям/группам автоматически присваиваются права, с которыми у них общие теги.
    - Например, мы хотим, чтобы какой-то пользователь имел все access и exec права пакета M5.
    - И мы знаем, что все эти автоматические права автоматически помечены тегом 'm5'.
    - Тогда, мы просто связываем этого пользователя с тегом 'm5', и дело в шляпе.

  # Выключатель системы проверки автоматически прав
    - Присутствует выключатель системы проверки автоматических прав.
    - Он находится в параметре "common_ison" конфига пакета.
    - Параметр принимает значения true / false.
    - Если выкл., состоянии права типов access и exec не проверяются.

  # Ограничение на минимальное кол-во символов в пароле
    - Во время регистрации нового пользователя требуется указать пароль.
    - Можно установить ограничение на его минимальную длину в символах.
    - За это отвечает параметр "common_min_chars_in_pass" в конфиге.

  # Механизм восстановления пароля
    - Восстановление пароля происходит по стандартной схеме.
    - Пользователь через интерфейс вводит email и запрашивает восстановление.
    - Генерируется секретный код, и записывается в спец.таблицу в БД.
    - В этой таблице есть datetime-стобец expire, где указано время истечения кода.
    - Время действия кода в минутах можно указать в параметре "common_pass_recovery_code_lifetime".
    - Система формирует URL с кодом в query string и посылает пользователю.
    - URL формируется на основе значения из параметра "common_url_auth_doc".
    - Если пользователь кликает поссылке до expire, ему формируется новый пароль.

  # Защита от брутфорса
    - Пакет имеет встроенную систему от брутфорса - взлома пароля перебором.
    - Её можно вкл./выкл. с помощью параметра "bruteforce_protection_ison".
    - Как работает:

        После "bruteforce_protection_threshold" неудачных попыток аутентификации
        за "bruteforce_protection_counter_lifetime" минут, с каждой последующей
        попыткой механизм аутентификации для этого пользователя блокируется
        на "bruteforce_protection_delay" * X, где X - кол-во неудачных попыток
        аутентификации за указанное время, минус "bruteforce_protection_threshold".

    - Механизм делает попытки взломать пароль брутфорсом бессмысленными.

  # Настройка времени жизни аутентификационной куки
    - Пакет позволяет гибко настроить время жизни в минутах.
    - Глобальное значение можно указать в параметре "auth_cookie_lifetime_global".
    - Локальные значения (для групп) можно указать в "auth_cookie_lifetime_locals".
    - Пользователь может состоять 0, 1 или одновременно в нескольких группах.
    - В любом случае, используется MIN значение (глобальное тоже берётся в расчёт).

  # Настройка переадресации после входа
    - То есть, настройка куда попадает пользователь после аутентификации.
    - Можно указать глобально url для переадресации в "redirect_global_url".
    - Но он не действует, если включить глобально механизм переадресации на ref-url.
    - Он включается / выключается в параметре "redirect_global_ref_ison".
    - Это такое общее правило, оно работает и на глобальном, и на локальных уровнях.
    - В "redirect_local_urls" можно локально указать url'ы для групп.
    - Если пользователь состоит в нескольких, берётся первое вхождение, начиная с глобального.
    - В "redirect_local_ref_ison" можно вкл./выкл. переадресацию на ref-url локально для базовых URL.

  # Настройка столбцов, которые можно использовать в качестве логина
    - В теории, в качестве логина можно использовать любой столбец.
    - Главное, чтобы у этого столбца был unique-индекс.
    - Пакет позволяет указать список таких столбцов.
    - Настроимть этот список можно в параметре "logins".

  # Настройка факторов и сценариев аутентификации
    - По умолчанию поддерживается 3 фактора аутентификации:
    - Их список находится в параметре "authfactors":

      1) password         // с помощью пароля
      2) sms              // через смс
      3) phrase           // вопрос - ответ (кодовая фраза)

    - Пакет позволяет настраивать сценарии аутентификации.
    - Глобальный сценарий можно указать в "authfactors_scenario_global".
    - Локальные сценарии для групп в "authfactors_scenarios_local".
    - Подробно сценарии аутентификации описаны в конфиге.

  # Настройка SMS-аутентификации
    - Длину пароля и набор символов можно указать в "smsauth_length" и "smsauth_charset".
    - Можно ограничить max кол-во смс в "smsauth_smslimit", отправляемых
      за время жизни счётчика "smsauth_counter_lifetime".
    - Последнее обновляется после каждой отправки смс.
    - Это ограничение позволит защититься от атак на наш счёт у смс-провайдера.

  # Настройка аутентификации через секретную фразу
    - Можно ограничить MIN длину ответа в символах параметром "phraseauth_length".


```
## Функционал <a id="link4"></a>
```

  # Команды и к.команды #
  #---------------------#

    Команда           К.Команда               Описание
    ----------------------------------------------------------------------------------------------------------------------
    update            m5:update               Fires m5:call4update event, gets data from M1/M4, updates DB of M5
    switch            m5:switch               Turn on / Turn off the system access restrictions
    checkanon         m5:checkanon            Check whether an anonymous user in the system
    checkadmins       m5:checkadmins          Check whether admins in the system
    getuserprivs      m5:getuserprivs         Get all user privileges, taking into account personal and privileges of groups, where user consists
    getgroupprivs     m5:getgroupprivs        Get all group privileges
    users             m5:users                Get users list (can use filters)
    groups            m5:groups               Get groups list (can use filters)
    privileges        m5:privileges           Get get privileges list (can use filters)
    tags              m5:tags                 Get tags list (can use filters)
    -                 m5:new                  Create a new user / group / privilege / tag
    newuser           -                       Create a new user
    newgroup          -                       Create a new group
    newprivilege      -                       Create a new privilege
    newtag            -                       Create a new tag
    -                 m5:del                  Delete a user / group / privilege / tag
    deluser           -                       Delete a user
    delgroup          -                       Delete a group
    delprivilege      -                       Delete a privilege
    deltag            -                       Delete a tag
    -                 m5:change               Change a user / group / privilege / tag
    changeuser        -                       Change a user
    changegroup       -                       Change a group
    changeprivilege   -                       Change a privilege
    changetag         -                       Change a tag
    -                 m5:restore              Restore a user / group / privilege / tag
    restoreuser       -                       Restore deleted user
    restoregroup      -                       Restore deleted group
    restoreprivilege  -                       Restore deleted privilege
    restoretag        -                       Restore deleted tag
    -                 m5:attach               Attach one entity to another
    attachuser        -                       Attach a user to a group
    attachprivilege   -                       Attach a privilege to a user / group
    attachtag         -                       Attach a tag to a user / group / privilege
    -                 m5:detach               Detach one entity from another
    detachuser        -                       Detach a user from a group
    detachprivilege   -                       Detach a privilege from a user / group
    detachtag         -                       Detach a tag from a user / group / privilege



  # Обработчики событий #
  #---------------------#

    Обработчик        Ключи                   Описание
    ----------------------------------------------------------------------------------------------------------------------
    H1_update         m1:afterupdate          Calls c.command m5:update, which invokes update of DB of M5
                      m4:afterupdate


```
## Схемы взаимодействий с другими пакетами <a id="link5"></a>
```

  # Pull-взаимодействия (по инициативе этого пакета) #
  #--------------------------------------------------#

    [M5 <---> M1,M4] Обновление БД пакета M5 данными от M1,M4
    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------
    M5                    m5:update                                       | Отправляем запрос на обновление
    M5                                                  m5:call4update    | данных пакетам M1,M4.

    M1                                  H2_fresh4m5                       | Обработчики в M1,M4 ловят запрос,
    M4                                  H2_fresh4m5                       | и возвращают необходимые данные.

    M5        C1_update                                                   | M5 принимает данные от M1,M4, и обновляет БД


  # Push-взаимодействия (по инициативе других пакетов) #
  #----------------------------------------------------#

    [M5 <---> M1] Обновление БД пакета M5 данными от M1
    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------
    M1        C1_parseapp
    M1                                                  m1:afterupdate
    M5                                  H1_update
    M5                    m5:update

      ... далее по сценарию из pull-взаимодействий ...

    [M5 <---> M4] Обновление БД пакета M5 данными от M1
    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------
    M1        C1_update
    M1                                                  m4:afterupdate
    M5                                  H1_update
    M5                    m5:update

      ... далее по сценарию из pull-взаимодействий ...


```
## Транс-пакетные связи <a id="link6"></a>
```

  Pivot     Локальная модель    Связанный M-пакет   Внешняя модель    Комментарий
  ----------------------------------------------------------------------------------------------------------------------




```
## Кэширование <a id="link7"></a>
```





```
## Заметки к релизам <a id="link100"></a>
```

  1.0.0
    - Первый релиз.

```










