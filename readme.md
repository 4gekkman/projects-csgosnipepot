# M9 - CSGO Lottery game
---
## Оглавление

  - [Ссылки](#link1)
  - [Введение](#link2)
  - [Теоретическая база](#link3)
	- [Функционал](#link98)
	- [Схемы взаимодействий с другими пакетами](#link99)
  - [Заметки к релизам](#link100)

---

## Ссылки <a id="link1"></a>
```

  > Адрес репозитория пакета M9 на github
      https://github.com/4gekkman/m9

			
```

## Введение <a id="link2"></a>
```

  > Каково назначение этого M-пакета?
    - Это игра "Lottery" для проведения розыгрышей скинов из CS:GO.

  > Пакет работает в связке с M8 и M5
    - Для работы пакету нужен функционал steam-ботов и автоматизации торговых операций.
    - А также требуется прямой доступ к БД пакета M5.
    - Поэтому, M9 зависит от M8 и M5.

```

## Теоретическая база <a id="link3"></a>
```

-----------------------------------
Оглавление

  # Ссылки
  # Введение

  # Игровые комнаты

    ▪ Что такое игровые комнаты
    ▪ Возможность прикреплять ботов к игровой комнате
    ▪ Режим приёма ставок в игровой комнате
    ▪ Игровую комнату можно включить/выключить
    ▪ Настройка раундов игровой комнаты

  # Раунды игры

    ▪ Что такое раунд игры
    ▪ Статус раунда
    ▪ История статусов раунда
    ▪ Как проходит раунд
    ▪ Ожидание обработки всех ставок перед розыгрышем
    ▪ Как заканчивается раунд
    ▪ Как работает счётчик раунда

  # Ставки в раундах игры

    ▪ Что такое ставки в раундах игры
    ▪ Статус ставки
    ▪ Какой бот принимает ту или иную ставку?
    ▪ Как производится обработка ставок
    ▪ Хранение шансов ставок в БД

  # Выигрыши в раундах игры

    ▪ Что такое выигрыши в раундах игры
    ▪ Статус выигрыша
    ▪ Какой бот выдаёт тот или иной выигрыш?
    ▪ Как производится обработка выигрышей

  # Свободные и не свободные вещи у ботов

    ▪ Что такое свободные и нет вещи, концептуально
    ▪ Что такое свободные и нет вещи, конкретно

  # Обеспечение отказоустойчивости приёма ставок и выплаты выигрышей

    ▪ Отказоустойчивость приёма ставок
    ▪ Отказоустойчивость выплаты выигрышей

-----------------------------------

> Ссылки

> Введение
  - Здесь рассмотрена теоретическая база игры типа "Лотерея" на скины из CS:GO.
  - Общим планом рассмотрена вся картина в целом, и ключевые её части.

> Игровые комнаты

  • Что такое игровые комнаты
    - Это наборы настроек для игры Лотерея.
    - Можно воспринимать их, как отдельные экземпляры игры.
    - Если существует N комнат, то игры параллельно в них проходят.

  • Возможность прикреплять ботов к игровой комнате
    - К каждой игровой комнате можно прикреплять любых зарегистрированных в приложении ботов.
    - Количество прикрепляемых ботов не ограничено.

  • Режим приёма ставок в игровой комнате
    - Каждая игровая комната работает в определённом режиме.
    - Имеется в виду то, каким образов прикреплённые боты принимают ставки.
    - Вот пример вариантов режима:

      ▪ roll          | боты принимают ставки по очереди
      ▪ availability  | ставку принимает первый работающий бот

  • Игровую комнату можно включить/выключить
    - После выключения новые раунды больше не создаются.
    - Текущий раунд, если он создан, завершается, как обычно.
    - Однако, выигрыши продолжают выплачиваться.

  • Настройка раундов игровой комнаты
    - В игровой комнате можно настроить параметры раундов.
    - А именно:

      ▪ Длительность раунда в секундах.

      ▪ MAX кол-во вещей для каждой ставки.
      ▪ MIN кол-во вещей для каждой ставки.
      ▪ MAX кол-во вещей для всего раунда.
      ▪ MIN кол-во вещей для всего раунда.

      ▪ MIN размер ставки ($)
      ▪ MAX размер ставки ($)
      ▪ MAX размер ставкок за раунд ($)
      ▪ MIN размер ставкок за раунд ($)

      ▪ Разрешать ли ставить вещи с нестабильными ценами
      ▪ Какие типы вещей разрешать ставить
        ▪ Кейсы
        ▪ Ключи
        ▪ Стартрек
        ▪ Сувенирные пакеты
        ▪ Сувениры
        ▪ Ножи
        ▪ Оружие

      ▪ Размер комиссии сервиса в %
      ▪ Выдавать ли выигрыши, используя сдачу
      ▪ Выдавать ли выигрыши строго 1-й операцией, от 1-го бота

  • Как работает механизм выдачи выигрышей с использованием сдачи
    - Не всегда можно легко взять точно комиссию из выигрыша.
    - Во многих случаях сервис будет недополучать из-за отсутствия "сдачи".
    - Если включить этот механизм, то выигрышы будут выплачиваться с использованием сдачи.
    - Некоторые дорогие скины будут размениваться на менее дорогие (типа ящиков).
    - И точность выплаты выигрышей и забора комиссии будет практически абсолютной.
    - В качестве сдачи будут выступать свободные вещи ботов, прикреплённых к ЛЮБОЙ комнате.

> Раунды игры

  • Что такое раунд игры
    - Как уже писалось выше, игровую комнату можно считать экземпляром игры со своими настройками.
    - Вся игра проходит раундами: первый раунд, второй, третий ... и так далее.
    - В каждом раунде могут быть N участников и лишь 1 победитель.

  • Статус раунда
    - У каждой комнаты есть свой статус в любой момент времени.
    - Он указывает на текущее состояние этого экземпляра игры.
    - Каждый раунд может иметь лишь 1-ин из следующих статусовв любой момент времени:

      ▪ Created       | Начался новый раунд, но ещё никто не сделал ставку.
      ▪ First bet     | Сделана первая и единственная пока ставка за раунд.
      ▪ Started       | Сделана вторая ставка за раунд, начался обратный отсчёт таймера.
      ▪ Pending       | Время игры закончилось, или достигнут лимит вещей. Ожидание обработки сделанных ранее ставок.
      ▪ Lottery       | Визуальное проведение розыгрыша.
      ▪ Winner        | Демонстрация победителя розыгрыша и его выигрыша.
      ▪ Finished      | Раунд завершён.

  • История статусов раунда
    - Для каждого раунда сохраняется история его статусов.
    - Дело в том, что таблицы раундов и статусов связаны m:n связью через pivot-таблицу.
    - Эта pivot-таблица имеет ряд дополнительных полей:

      ▪ started_et    | Момент времени, когда раунд получил данный статус
      ▪ ended_at      | Момент времени, когда раунд переключился с этого статуса на другой
      ▪ comment       | Комментарий

    - За весь свой жизненный цикл раунд побывает последовательно во всех 7-ти статусах.
    - Узнать его текущий статус, можно получив историю и взяв наиболее "поздний" статус.

  • Как проходит раунд

    ▪ Created
      - Сначала раунд создаётся и ожидает первых ставок.
      - Возможно, новый раунд будет создан сразу с 1-й или N-ставками,
        которые не попали в предыдущий, и перекочевали в этот раунд.
      - Если перекочевала ставка(и) 1-го игрока, сразу загружается статус First bet.
      - А если нескольких игроков, то статус Started.
      - Однако, не может перекочевать больше ставок, чем предметов может вместить раунд.

    ▪ First bet
      - Кто-то делает первую ставку в раунде, и статус переключается на First bet.

    ▪ Started
      - Кто-то делает 2-ю ставку в раунде, и статус переключается на Started.

    ▪ Pending
      - Наступает момент, когда либо время вышло, либо достигнуто max кол-во предметов в раунде.
      - Тогда статус переключается на Pending, приём ставок в этом раунде прекращается.
      - Пользователем показывается сообщение, вроде: "подождите, пока мы обработаем все ставки в очереди".
      - И сервер обрабатывает эти ставки.

    ▪ Lottery
      - Как только в очереди осталось 0 не обработанных ставок, статус переключается на Lottery.
      - Сервер проводит вычисления, определяет победителя, отправляет клиентам эту информацию.
      - У клиентов запускается анимация розыгрыша.

    ▪ Winner
      - По плану, анимация розыгрыша должна длиться столько, сколько указано в конфиге.
      - После окончания этого времени с момента старта статуса Lottery, сервер автоматически
        переключает статус раунда на Winner.
      - У клиентов запускается анимация демонстрации победителя.

    ▪ Finished
      - В конфиге также указано время, которое анимация выигрыша должна длиться.
      - По истечении этого времени с момента старта статуса Winner, сервер автоматически
        переключает статус раунда на Finished.

  • Ожидание обработки всех ставок перед розыгрышем
    - Когда выходит время, или достигается лимит по вещам/деньгам, статус переключается на pending.
    - Приём ставок заканчивается, ожидается обработка сделанных ранее ставок.

  • Как заканчивается раунд
    - Как только все сделанные ранее ставки обработаны, производится розыгрыш (занимает мгновения).
    - Статус раунда переключается на finished.

  • Как работает счётчик раунда

    ▪ Лимит на длительность раунда
      - У каждого раунда есть поле room_round_duration_sec.
      - Оно содержит в себе лимит на длительность раунда в секундах.
      - Если значение == 0, то длительность раунда не ограничена.

    ▪ Отсчёт должен начинаться с момента переключения в состояние "Started"
      - У каждого состояния в md1001 есть поле "started_at".
      - В нём содержится DATETIME-значение с датой/временем переключения в это состояние.
      - Отсчёт времени счётчика раунда ведётся с этого момента.

    ▪ Отсчёт должен заканчиваться с момента переключения в состояние "Pending"
      - У каждого состояния в md1001 есть поле "started_at".
      - В нём содержится DATETIME-значение с датой/временем переключения в это состояние.
      - Отсчёт времени счётчика раунда ведётся до этого момента.

    ▪ Переключение в состояние "Pending" при достижении счётчиком лимита
      - При достижении счётчиком времени лимита, раунд переключается в состояние "Pending".

    ▪ Как рассчитывать оставшееся до конца раунда время на стороне клиента

      ▪ Если лимит на длительность раунда не установлен
        - То есть, room_round_duration_sec == "0".
        - Независимо от текущего состояния раунда.
        - Использовать символ бесконечности: "∞".

      ▪ Если состояние раунда не "Created" или "First bet"
        - И room_round_duration_sec != "0".
        - То использовать значение из room_round_duration_sec.

      ▪ Если состояние раунда "Pending", "Lottery", "Winner" или "Finished"
        - И room_round_duration_sec != "0".
        - То использовать значение "0".

      ▪ Если состояние раунда "Started"
        - И room_round_duration_sec != "0".
        - И если принять такие обозначения:

          Ts        | Время начала состояния "Started" раунда (started_at)
          Tn        | Текущее серверное время
          Tl        | Длительность раунда (значение room_round_duration_sec)

        - То:

          ▪ Если Tn - Ts >= Tl
            - Использовать значение "0".
            - Когда такое происходит, раунд должен переключиться в "Pending".

          ▪ Если Tn - Ts < Tl
            - Использовать значение: Ts - Tn

> Ставки в раундах игры

  • Что такое ставки в раундах игры
    - В любом раунде любой комнаты игроки могут делать ставки.
    - Игрок ставит вещи, которые принимает один из прикреплённых к комнате ботов.

  • Статус ставки
    - Каждая ставка в любой момент имеет определённый статус.
    - Вот примеры таких статусов:

      ▪ processing  | не обработана
      ▪ accepted    | принята
      ▪ declined    | отклонена (почему - см. status_note)

  • Какой бот принимает ту или иную ставку?
    - Это зависит от режима приёма ставок в игровой комнате.
    - Его можно указать в настройках каждой игровой комнаты.
    - Подробнее об этом читай выше, в разделе про игровые комнаты.

  • Как производится обработка ставок
    - Как только игрок сделал ставку, и она записана в БД, она получает статус processing.
    - Это означает, что ни один из ботов ещё не принял те вещи, которые поставил пользователь.
    - Затем бот, который должен принять ставку, пытается это сделать.
    - Если он добивается успеха, статус ставки становится accepted.
    - Если со ставкой или партнёром что-то не так (запрещённые типы вещей, партнёр без 2FA, и т.д.),
      бот отклоняет ставку и делает её статус declined.
    - Также, если ни один бот не может принять ставку, её статус также становится declined.

  • Хранение шансов ставок в БД

    ▪ Смысл
      - Хранить в базе целое число.

    ▪ Соглашения:
      1. Храним от 12 до 1 знака.
      2. Если знаков от 11 до 12, значит целая часть есть.
      3. Если знаков 10, значит целой части нет.

    ▪ Примеры:
      33 333 333 333 3    | 33.3333333333%   | Всего 12 знаков
      3 333 333 333 3      | 3.3333333333%     | Всего 11 знаков
      333 333 333 3         | 0.3333333333%     | Всего 10 знаков
      333 333 333            | 0.0333333333%     | Всего 9 знаков
      333 333 33              | 0.0033333333%     | Всего 8 знаков
      333 333 3                | 0.0003333333%     | Всего 7 знаков
      333 333                   | 0.0000333333%     | Всего 6 знаков
      333 33                     | 0.0000033333%     | Всего 5 знаков
      333 3                       | 0.0000003333%     | Всего 4 знаков
      333                          | 0.0000000333%     | Всего 3 знака
      33                            | 0.0000000033%     | Всего 2 знака
      3                              | 0.0000000003%     | Всего 1 знак

> Выигрыши в раундах игры

  • Что такое выигрыши в раундах игры
    - Каждый раунд со статусом finished должен иметь своего игрока-победителя.
    - Как только раунд становится finished, для него создаётся выигрыш.
    - Выигрыш связан с победившим пользователем, вещами из банка и ботами, у которых они лежат.

  • Статус выигрыша
    - Каждый выигрыш в любой момент имеет определённый статус.
    - Вот примеры таких статусов:

      ▪ processing      | не обработан
      ▪ pending         | ожидает принятия игроком
      ▪ paid            | выплачен
      ▪ canceled        | аннулирован из-за истечения времени

  • Какой бот выдаёт тот или иной выигрыш?
    - Это зависит от ряда настроек игровой комнаты:

      ▪ Размер комиссии сервиса в %
      ▪ Выдавать ли выигрыши, используя сдачу
      ▪ Выдавать ли выигрыши строго 1-й операцией, от 1-го бота

    - Исходя из них система вычисляет, какие боты какие вещи должны выплатить в виде выигрыша.
    - В любом случае, система старается (по мере возможности) выигрыш выдавать именно вещами из банка.
    - Если выигрыш должен выдавать 1-ин бот, то система проводит ряд операций по передаче вещей,
      которые должны быть выданы в виде выигрыша, этому боту.

  • Время на то, чтобы забрать выигрыш, у пользователя ограничен
    - В настройках комнаты указывается время в минутах.
    - Отсчёт начинается с того момента, когда статус выигрыша переключается с processing на pending.
    - Если пользователь за это время не забирает выигрыш, соотв.торговые предложения отменяются.

  • Как производится обработка выигрышей
    - Как только статус раунда становится finished, система вычисляет, какие боты какие вещи должны выплатить.
    - Создаётся соответствующая запись в таблице выигрышей, с соответствующими связями, и статусом processing.
    - Как только все торговоые (ое) предложения успешно отправлены пользователю, статус выигрыша меняется на pending,
      и время этого события записывается в модель соотв.выигрыша.
    - Система периодически проверяет, не зарбал ли игрок выигрыш.
    - Если забрал до истечения времени, то статус выигрыша становится paid.
    - Если не забрал, соотв.торговые предложения отменяются, и статус становится canceled.

> Свободные и не свободные вещи у ботов

  • Что такое свободные и нет вещи, концептуально
    - У прикреплённых к любой комнате ботов могут быть свободные и нет вещи.
    - Со свободными вещами можно делать что угодно, они - наша собственность.
    - Не свободные вещи задействованы в каких-то операциях, они - не наша собственность.
    - Не свободные вещи нельзя никуда перемещать, или что-либо с ними делать.

  • Что такое свободные и нет вещи, конкретно
    - Рассмотрим конкретно, что такое не свобоные вещи.
    - Все вещи, не являющиеся не свободными, считаются свободными.
    - Итак, несводобные вещи, это:

      ▪ Вещи из ставок, связанные с активным (не finished) раундом.
      ▪ Вещи, связанные с выигрышами с любым статусом, кроме canceled.

> Обеспечение отказоустойчивости приёма ставок и выплаты выигрышей

  • Отказоустойчивость приёма ставок
    - Пользователь нажимает на кнопку "сделать ставку", выбирает, что хочет поставить, и нажимает "поставить".
    - Сервер всё это получает, выбирает бота, который готов принять, и возвращает соотв.url.
    - Это торговый url выбранного бота, с параметрами вещей, которые требуется поставить.
    - Пользователь переадресуется по указанному адресу:
      ▪ Если это не мак, то создаётся всплывающее окошко.
      ▪ Если это мак, то в новой вкладке.

  • Отказоустойчивость выплаты выигрышей
    - Необходимо периодически проверять авторизацию и наличие вещей для выплаты у ботов для pending-выигрышей.
    - Если что-либо отсутствует, всё отменять, и производить перерасчёт (оставляя то же самое стартовое время).


```

## Функционал <a id="link98"></a>
```

  # Команды и к.команды общего назначения #
  #---------------------------------------#

    Команда                 К.Команда                   Описание
    ----------------------------------------------------------------------------------------------------------------------
    command                 | m1:command                | Description of the command


```
## Схемы взаимодействий с другими пакетами <a id="link99"></a>
```

  # Pull-взаимодействия (по инициативе этого пакета) #
  #--------------------------------------------------#

    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------

      -

  # Push-взаимодействия (по инициативе других пакетов) #
  #----------------------------------------------------#

    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------

      -


```
## Заметки к релизам <a id="link100"></a>
```

  1.0.0
    - Первый релиз.

```










