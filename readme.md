# M14 - CSGO skins shop
---
## Оглавление

  - [Ссылки](#link1)
  - [Концепция актуализации товарных остатков магазина](#link2)
  - [Концепция безопасной обработки покупок в магазине](#link3)
  - [Концепция работы с вещами на заказ](#link4)
  - [Заметки к релизам](#link100)

---

## Ссылки <a id="link1"></a>
```

  # Адрес репозитория пакета M14 на github
      https://github.com/4gekkman/m14

	
			
```

## Концепция актуализации товарных остатков магазина <a id="link2"></a>
```
-----------------------------------
Оглавление

  # В магазине продаются скины ботов из определённой группы ботов
  # Какие скины из группы ботов магазина являются товарами в магазине
  # Кэш товаров для каждого из ботов из группы магазина
  # Удаление купленных товаров из кэша товаров каждого бота без запроса инвентаря в Steam
  # Очередь обновлений товаров магазина
  # Актуальный Единый Кэш (АЕК) всех товаров магазина
  # Триггеры обновлений кэша, синхронизации с моделями клиентов

-----------------------------------

  # В магазине продаются скины ботов из определённой группы ботов
    - К магазину подключены боты из группы "Shop", или иной, указанной в конфиге.
    - В магазине продаются скины этих ботов.

  # Какие скины из группы ботов магазина являются товарами в магазине
    - Все скины всех ботов из группы магазина.
    - Кроме тех, что связаны с активными трейдами в M14.

  # Кэш товаров для каждого из ботов из группы магазина
    - Инвентарь каждого бота извлекается с помощью "m8.c4_getinventory".
    - Исключаются вещи, связанные с активными трейдами в M14 (авто-удаление купленных товаров).
    - Товары по каждому отдельному боту записываются в кэш: "M14:goods:<steamid бота>".
    - По каждому боту обновление должно происходить отдельной командой, добавляемой в очередь: "m14_goods_update_queue".

  # Удаление купленных товаров из кэша товаров каждого бота без запроса инвентаря в Steam
    - Steam ограничивает кол-во запросв инвентаря в ед.времени, так что надо их экономить.
    - После покупки вещей и списания монет надо вручную модифицировать кэш товаров соотв.ботов.
    - Эта операция должна производитсья отдельной командой, добавляемой в очередь: "m14_goods_update_queue".
    - После каждой такой операции надо обновить единый кэш товаров, и транслировать его всем клиентам чере открытый канал.

  # Очередь обновлений товаров магазина
    - При обновлении остатков товаров магазина необходимо использовать очередь во избежание коллизий.
    - Предлагается использовать очередь "m14_goods_update_queue", обслуживаемую отдельным демоном.
    - По существу, в эту очередь будут добавляться 2 типа операций:

      1) Обновление кэша товаров бота магазина с запросом из Steam.
      2) Удаление купленного товара(ов) из кэша товаров бота магазина без запроса из Steam.

  # Актуальный Единый Кэш (АЕК) всех товаров магазина
    - Этот кэш будет передаваться клиенту при первом открытии магазина.
    - Он должен обновляться при каждом обновлении кэша товаров каждого бота из группы магазина.
    - Задачей системы является постоянная и мгновенная синхронизация АЕК с моделями всех клиентов.
    - Надо учитывать, что синхронизации могут быть очень частыми, и не надо каждый раз транслировать все товары:

      1) Нагрузка будет слишком велика.
      2) Интерфейс все время будет "мигать" и перерисовываться, и пользоваться будет неудобно.

    - Необходимо доставлять пуши-синхронизации с 2-мя массивами товаров:

      1) "add" - список товаров, которые надо добавить в клиентскую модель.
      2) "subtract" - список товаров, которые надо вычесть из клиентской модели.

    - АЕК будет доступен с ключём: "M14:goods".

  # Триггеры обновлений кэша, синхронизации с моделями клиентов

    • Обновление кэша товаров бота магазина с запросом из Steam происходит по расписанию

      ▪ Команда update_bot_goods
        - Кэш товаров 1-го бота с указанным steamid можно обновить командой "update_bot_goods".
        - Выполнение этой команды должно производиться только через очередь "m14_goods_update_queue".
        - В конце этой команды возбуждается событие: "m14:goods:update".

      ▪ Команда update_all_bots_goods
        - Она извлекает список всех ботов из группы магазина.
        - И для каждого из них добавляет команду update_bot_goods в очередь "m14_goods_update_queue".
        - В конце каждой update_bot_goods возбуждается событие: "m14:goods:update".
        - Команда запускается каждые 15 минут планировщиком задач.

    • Удаление купленного товара(ов) из кэша товаров бота магазина без запроса из Steam

      ▪ Команда subtract_goods
        - Она принимает steamid бота и список assetid его скинов.
        - Она должна вычесть эти скины из кэша товаров этого бота (и обновить его).
        - Команда subtract_goods выполняется в конце команды make_offer.
        - В конце этой команды возбуждается событие: "m14:goods:update".

    • Обработка события "m14:goods:update"

      ▪ Обработчик goods_update
        - Ловит событие "m14:goods:update".
        - Выполняет команду all_goods_update.

      ▪ Команда all_goods_update
        - Она извлекает список всех ботов из группы магазина.
        - Объединяет кэш товаров всех этих ботов в единый массив данных.
        - Получает "add"- и "subtract"-разницу для их последующей трансляции.
        - Записывает новый массив данных в кэш.
        - Транслирует через публичный канал массивы товаров "add" и "subtarct".

```

## Концепция безопасной обработки покупок в магазине <a id="link2"></a>
```
-----------------------------------
Оглавление

  # Процесс покупки с точки зрения рядового покупателя
  # Процесс безопасной обработки покупок

-----------------------------------

  # Процесс покупки с точки зрения рядового покупателя
    - Выбираю скины, которые хочу купить, нажимаю "Купить".
    - У меня списывают монеты, об этом мне приходит уведомление.
    - Появляется уведомление со ссылкой на обмен для получения предметов,
      кодом безопасности и предупреждении об ограниченном времени действия.
    - Я должен принять торговое предложение в течение указанного времени,
      иначе оно будет отменено без возвращения монет.

  # Процесс безопасной обработки покупок

    1. Создаём записи в таблице трейдов
      - С payment_status_id == 1 (ожидает оплаты).
      - До поступления оплаты трейдов в Steam не создаётся.
      - Указываем кол-во монет, которые надо списать.
      - В id_status указываем 0.

    2. Производим клиринг трейдов
      - В процессоре специальная команда производит клиринг.
      - Все операции клиринга только через очередь.
      - В случае успешного клиринга, payment_status_id меняется на 2.
      - В случае неудачного клиринга, payment_status_id меняется на 3.

    3. Создаём сами трейды в Steam
      - Для трейдов, у которых id_status == 0 и payment_status_id == 2.
      - После успешного создания трейда записываем tradeofferid.

    4. Отслеживаем состояние трейдов
      - С id_status != 0
        - В том числе, и "потерявшиеся" трейды.
        - Если оно поменялось, меняем id_status на соотв.
      - С id_status == 0
        - Если время вышло, а трейд так и не был создан.
        - Меняем id_status на -1.

    5. Отслеживаем возвраты монет
      - Ищем трейды с id_status == -1, время которых прошло > 24 часов (или указанное в конфиге).
      - Возвращаем списанные по ним монеты их владельцам.


```

## Концепция работы с вещами на заказ <a id="link3"></a>
```
-----------------------------------
Оглавление

  # Принципиальная концепция без технических подробностей
  # Интерфейс в админке
  # Концепция работы со скинами на заказ с технической стороны

-----------------------------------

  # Принципиальная концепция без технических подробностей
    - В нашем магазине можно покупать скины на заказ.
    - Доступные на заказ скины хранятся в отдельной таблице в базе данных.
    - В админке можно просматривать их, добавлять и удалять.
    - Когда такой скин заказывают в магазине:

      1) Система списывает за него монеты.
      2) Скин исчезает из магазина.
      3) Его market name, ссылка на обмен пользователя и steamid покупателя отправляются на указанный в конфиге email.
      4) Пользователь получает уведомление, что этот скин он получит в течение указанного в конфиге кол-ва часов.

  # Интерфейс в админке
    - Общий вид интерфейса будет, как у нашего FAQ.
    - Справа будут подразделы интерфейса (ведь у магазина их может быть много), а слева контент.
    - Одним из подразделов будет "Скины на заказ", с ним то и будет работать.
    - В нём будет список скинов на заказ, в виде таких же квадратиков, как в магазине.
    - При наведении на квадратик также будет появляться крестик "Удалить".
    - Где-нибудь сверху будет кнопка "Добавить".
    - При её нажатии список скинов на заказ скрывается, а показывается список скинов для добавления.
    - В конфиге можно будет указать MIN стоимость скинов для добавления.
    - При наведении на скин для добавления на нём светится зелёная надпись "добавить".
    - При клике по скину для добавления, он добавляется, а интерфейс переключается обратно на список скинов на заказ.

  # Концепция работы со скинами на заказ с технической стороны

    • Парадигма
      - Функционалы работы с заказными и обычными скинами существуют параллельно.
      - Они не переплетаются между собой, а существуют отдельно друг от друга.

    • Общая полная концепция кратко
      - У нас есть отдельная таблица скинов на заказ (ТСЗ).
      - По расписанию, раз минут в 15, мы обновляем кэш с актуальными списком доступных на заказ скинов (АСДЗС).
      - Кэш представляет массив объектов-скинов, с полями, потребляемыми клиентом.
        Т.Е., если их просто добавить в items на клиенте, они нормально отобразятся.
      - Плюс, у них должно быть булеан-поле, позволяющее отличать их от нормальных скинов.
      - При 1-м открытии мы загружаем кэш СЗ в функции update_goods_full, вместе с кэшем обычных скинов.
      - При выполнении функции buy СЗ отделяются от обычных, и отсылаются отдельным массивом.
      - Обработка СЗ производится прямо в C5_buy, не отходя от кассы:
        - СЗ учитываются при проверке наличия монет у пользователя для покупки.
        - Далее в общую очередь магазина добавляется команда C19_to_order_skins_processing:
          - В проверяется резерв.
          - Производится клиринг (списание монет).
          - Меняется статус СЗ-части заказа на "оплачено".
          - Отправляется email по адресу из конфига с данными по СЗ.
          - Выполняется команда C18_update_tos_goods, обновляющая кэш АСДЗС, и транслирующая обновления клиенту.

    • ТСЗ связывается с purchases и m8_items
      - Со строкой из purchases связываются вещи из ТСЗ, заказанные в оной.
      - Каждая строка из purchases связана с 1-й вещью из m8_items, а в pivot цена на момент покупки.

    • Столбцы в ТСЗ

      ▪ Итоговый набор полей, который должен быть у вещей СЗ в кэше

        id                  | ID скина на заказ
        id_status           | 1 - доступен в магазине, 2 - куплен.
        assetid             | Внутренний assetid скина
        icon_url            | URL на картинку скина
        is_price_unstable   | Является ли цена нестабильной
        market_name         | Название и качество скина
        market_hash_name    | Название и качество скина
        price               | Цена в центах
        price_success       | Удалось ли извлечь цену
        quality             | Строка с качеством
        itemtypes           | Формируемое поле, аналогичное оному у обычных скинов
        is_order            | Поле, содержащее 1. Если оно есть, значит это скин на заказ.
        created_at
        updated_at

      ▪ Итоговый набор полей, который должен быть в ТСЗ

        id
        id_status
        assetid
        created_at
        updated_at

      ▪ Рассмотрим стандартные поля обычного скина, какие из них нам нужны в ТСЗ

        Стандартные                       Нужен ли
        ------------------------------------------
        assetid                           Да
        icon_url                          Да
        is_price_unstable                 Да
        itemtypes                         Да
        market_name                       Да
        price                             Да
        price_success                     Да
        quality                           Да

        actions                           Нет
        appid                             Нет
        background_color                  Нет
        category                          Нет
        classid                           Нет
        collection                        Нет
        commodity                         Нет
        descriptions                      Нет
        exterior                          Нет
        icon_drag_url                     Нет
        icon_url_large                    Нет
        instanceid                        Нет
        market_actions                    Нет
        martet_hash_name                  Нет
        market_tradable_restriction       Нет
        marketable                        Нет
        name                              Нет
        name_color                        Нет
        quality_color                     Нет
        tags                              Нет
        tradable                          Нет
        type                              Нет
        weapon                            Нет







```


## Заметки к релизам <a id="link100"></a>
```

  1.0.0
    - Первый релиз.

```










