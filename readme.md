# M9 - CSGO Lottery game
---
## Оглавление

  - [Ссылки](#link1)
  - [Введение](#link2)
  - [Теоретическая база](#link3)
	- [Функционал](#link98)
	- [Схемы взаимодействий с другими пакетами](#link99)
  - [Заметки к релизам](#link100)

---

## Ссылки <a id="link1"></a>
```

  > Адрес репозитория пакета M9 на github
      https://github.com/4gekkman/m9

			
```

## Введение <a id="link2"></a>
```

  > Каково назначение этого M-пакета?
    - Это игра "Lottery" для проведения розыгрышей скинов из CS:GO.

  > Пакет работает в связке с M8 и M5
    - Для работы пакету нужен функционал steam-ботов и автоматизации торговых операций.
    - А также требуется прямой доступ к БД пакета M5.
    - Поэтому, M9 зависит от M8 и M5.

```

## Теоретическая база <a id="link3"></a>
```

-----------------------------------
Оглавление

  # Ссылки
  # Введение

  # Игровые комнаты

    ▪ Что такое игровые комнаты
    ▪ Возможность прикреплять ботов к игровой комнате
    ▪ Режим приёма ставок в игровой комнате
    ▪ Игровую комнату можно включить/выключить
    ▪ Настройка раундов игровой комнаты

  # Раунды игры

    ▪ Что такое раунд игры
    ▪ Статус раунда
    ▪ Как начинается раунд
    ▪ Ожидание обработки всех ставок перед розыгрышем
    ▪ Как заканчивается раунд

  # Ставки в раундах игры

    ▪ Что такое ставки в раундах игры
    ▪ Статус ставки
    ▪ Какой бот принимает ту или иную ставку?
    ▪ Как производится обработка ставок

  # Выигрыши в раундах игры

    ▪ Что такое выигрыши в раундах игры
    ▪ Статус выигрыша
    ▪ Какой бот выдаёт тот или иной выигрыш?
    ▪ Как производится обработка выигрышей

  # Свободные и не свободные вещи у ботов

    ▪ Что такое свободные и нет вещи, концептуально
    ▪ Что такое свободные и нет вещи, конкретно

  # Обеспечение отказоустойчивости приёма ставок и выплаты выигрышей



-----------------------------------

> Ссылки

> Введение
  - Здесь рассмотрена теоретическая база игры типа "Лотерея" на скины из CS:GO.
  - Общим планом рассмотрена вся картина в целом, и ключевые её части.

> Игровые комнаты

  • Что такое игровые комнаты
    - Это наборы настроек для игры Лотерея.
    - Можно воспринимать их, как отдельные экземпляры игры.
    - Если существует N комнат, то игры параллельно в них проходят.

  • Возможность прикреплять ботов к игровой комнате
    - К каждой игровой комнате можно прикреплять любых зарегистрированных в приложении ботов.
    - Количество прикрепляемых ботов не ограничено.

  • Режим приёма ставок в игровой комнате
    - Каждая игровая комната работает в определённом режиме.
    - Имеется в виду то, каким образов прикреплённые боты принимают ставки.
    - Вот пример вариантов режима:

      ▪ roll          | боты принимают ставки по очереди
      ▪ availability  | ставку принимает первый работающий бот

  • Игровую комнату можно включить/выключить
    - После выключения новые раунды больше не создаются.
    - Текущий раунд, если он создан, завершается, как обычно.
    - Однако, выигрыши продолжают выплачиваться.

  • Настройка раундов игровой комнаты
    - В игровой комнате можно настроить параметры раундов.
    - А именно:

      ▪ Длительность раунда в секундах.

      ▪ MAX кол-во вещей для каждой ставки.
      ▪ MIN кол-во вещей для каждой ставки.
      ▪ MAX кол-во вещей для всего раунда.
      ▪ MIN кол-во вещей для всего раунда.

      ▪ MIN размер ставки ($)
      ▪ MAX размер ставки ($)
      ▪ MAX размер ставкок за раунд ($)
      ▪ MIN размер ставкок за раунд ($)

      ▪ Разрешать ли ставить вещи с нестабильными ценами
      ▪ Какие типы вещей разрешать ставить
        ▪ Кейсы
        ▪ Ключи
        ▪ Стартрек
        ▪ Сувенирные пакеты
        ▪ Сувениры
        ▪ Ножи
        ▪ Оружие

      ▪ Размер комиссии сервиса в %
      ▪ Выдавать ли выигрыши, используя сдачу
      ▪ Выдавать ли выигрыши строго 1-й операцией, от 1-го бота

  • Как работает механизм выдачи выигрышей с использованием сдачи
    - Не всегда можно легко взять точно комиссию из выигрыша.
    - Во многих случаях сервис будет недополучать из-за отсутствия "сдачи".
    - Если включить этот механизм, то выигрышы будут выплачиваться с использованием сдачи.
    - Некоторые дорогие скины будут размениваться на менее дорогие (типа ящиков).
    - И точность выплаты выигрышей и забора комиссии будет практически абсолютной.
    - В качестве сдачи будут выступать свободные вещи ботов, прикреплённых к ЛЮБОЙ комнате.

> Раунды игры

  • Что такое раунд игры
    - Как уже писалось выше, игровую комнату можно считать экземпляром игры со своими настройками.
    - Вся игра проходит раундами: первый раунд, второй, третий ... и так далее.
    - В каждом раунде могут быть N участников и лишь 1 победитель.

  • Статус раунда
    - У каждой комнаты есть свой статус в любой момент времени.
    - Он указывает на текущее состояние этого экземпляра игры.
    - Вот пример статусов:

      ▪ created       | ещё не запущен, ставки принимаются
      ▪ started       | запущен, ещё не кончился, ставки принимаются
      ▪ pending       | ожидание обработки ставок, ставки не принимаются
      ▪ finished      | завершён, победитель определён, ставки не принимаются

  • Как начинается раунд
    - Сначала раунд создаётся и ожидает первых ставок (статус created).
    - Когда первые 2 игрока сделали ставки, раунд начинается (статус started).
    - Как только статус раунда переключается на started, в БД записывается время начала раунда.

  • Ожидание обработки всех ставок перед розыгрышем
    - Когда выходит время, или достигается лимит по вещам/деньгам, статус переключается на pending.
    - Приём ставок заканчивается, ожидается обработка сделанных ранее ставок.

  • Как заканчивается раунд
    - Как только все сделанные ранее ставки обработаны, производится розыгрыш (занимает мгновения).
    - Статус раунда переключается на finished.

> Ставки в раундах игры

  • Что такое ставки в раундах игры
    - В любом раунде любой комнаты игроки могут делать ставки.
    - Игрок ставит вещи, которые принимает один из прикреплённых к комнате ботов.

  • Статус ставки
    - Каждая ставка в любой момент имеет определённый статус.
    - Вот примеры таких статусов:

      ▪ processing  | не обработана
      ▪ accepted    | принята
      ▪ declined    | отклонена (почему - см. status_note)

  • Какой бот принимает ту или иную ставку?
    - Это зависит от режима приёма ставок в игровой комнате.
    - Его можно указать в настройках каждой игровой комнаты.
    - Подробнее об этом читай выше, в разделе про игровые комнаты.

  • Как производится обработка ставок
    - Как только игрок сделал ставку, и она записана в БД, она получает статус processing.
    - Это означает, что ни один из ботов ещё не принял те вещи, которые поставил пользователь.
    - Затем бот, который должен принять ставку, пытается это сделать.
    - Если он добивается успеха, статус ставки становится accepted.
    - Если со ставкой или партнёром что-то не так (запрещённые типы вещей, партнёр без 2FA, и т.д.),
      бот отклоняет ставку и делает её статус declined.
    - Также, если ни один бот не может принять ставку, её статус также становится declined.

> Выигрыши в раундах игры

  • Что такое выигрыши в раундах игры
    - Каждый раунд со статусом finished должен иметь своего игрока-победителя.
    - Как только раунд становится finished, для него создаётся выигрыш.
    - Выигрыш связан с победившим пользователем, вещами из банка и ботами, у которых они лежат.

  • Статус выигрыша
    - Каждый выигрыш в любой момент имеет определённый статус.
    - Вот примеры таких статусов:

      ▪ processing      | не обработан
      ▪ pending         | ожидает принятия игроком
      ▪ paid            | выплачен
      ▪ canceled        | аннулирован из-за истечения времени

  • Какой бот выдаёт тот или иной выигрыш?
    - Это зависит от ряда настроек игровой комнаты:

      ▪ Размер комиссии сервиса в %
      ▪ Выдавать ли выигрыши, используя сдачу
      ▪ Выдавать ли выигрыши строго 1-й операцией, от 1-го бота

    - Исходя из них система вычисляет, какие боты какие вещи должны выплатить в виде выигрыша.
    - В любом случае, система старается (по мере возможности) выигрыш выдавать именно вещами из банка.
    - Если выигрыш должен выдавать 1-ин бот, то система проводит ряд операций по передаче вещей,
      которые должны быть выданы в виде выигрыша, этому боту.

  • Время на то, чтобы забрать выигрыш, у пользователя ограничен
    - В настройках комнаты указывается время в минутах.
    - Отсчёт начинается с того момента, когда статус выигрыша переключается с processing на pending.
    - Если пользователь за это время не забирает выигрыш, соотв.торговые предложения отменяются.

  • Как производится обработка выигрышей
    - Как только статус раунда становится finished, система вычисляет, какие боты какие вещи должны выплатить.
    - Создаётся соответствующая запись в таблице выигрышей, с соответствующими связями, и статусом processing.
    - Как только все торговоые (ое) предложения успешно отправлены пользователю, статус выигрыша меняется на pending,
      и время этого события записывается в модель соотв.выигрыша.
    - Система периодически проверяет, не зарбал ли игрок выигрыш.
    - Если забрал до истечения времени, то статус выигрыша становится paid.
    - Если не забрал, соотв.торговые предложения отменяются, и статус становится canceled.

> Свободные и не свободные вещи у ботов

  • Что такое свободные и нет вещи, концептуально
    - У прикреплённых к любой комнате ботов могут быть свободные и нет вещи.
    - Со свободными вещами можно делать что угодно, они - наша собственность.
    - Не свободные вещи задействованы в каких-то операциях, они - не наша собственность.
    - Не свободные вещи нельзя никуда перемещать, или что-либо с ними делать.

  • Что такое свободные и нет вещи, конкретно
    - Рассмотрим конкретно, что такое не свобоные вещи.
    - Все вещи, не являющиеся не свободными, считаются свободными.
    - Итак, несводобные вещи, это:

      ▪ Вещи из ставок, связанные с активным (не finished) раундом.
      ▪ Вещи, связанные с выигрышами с любым статусом, кроме canceled.

> Обеспечение отказоустойчивости приёма ставок и выплаты выигрышей

  • Отказоустойчивость приёма







```

## Функционал <a id="link98"></a>
```

  # Команды и к.команды общего назначения #
  #---------------------------------------#

    Команда                 К.Команда                   Описание
    ----------------------------------------------------------------------------------------------------------------------
    command                 | m1:command                | Description of the command


```
## Схемы взаимодействий с другими пакетами <a id="link99"></a>
```

  # Pull-взаимодействия (по инициативе этого пакета) #
  #--------------------------------------------------#

    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------

      -

  # Push-взаимодействия (по инициативе других пакетов) #
  #----------------------------------------------------#

    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------

      -


```
## Заметки к релизам <a id="link100"></a>
```

  1.0.0
    - Первый релиз.

```










