# M11 - This M-package make ticks every N seconds and translate it via event system
---
## Оглавление

  - [Ссылки](#link1)
  - [Введение](#link2)
  -
	- [Функционал](#link98)
	- [Схемы взаимодействий с другими пакетами](#link99)
  - [Заметки к релизам](#link100)

---

## Ссылки <a id="link1"></a>
```

  > Адрес репозитория пакета M11 на github
      https://github.com/4gekkman/m11



```

## Введение <a id="link2"></a>
```

  --- Оглавление

    ▪ Тики: что это такое?
    ▪ Тики: как часто могут тикать?
    ▪ Тики: зачем нужны?

    ▪ Скорость и надёжность: демон queue:work
    ▪ Скорость и надёжность: очередь задач "tick"
    ▪ Скорость и надёжность: используется supervisor

    ▪ queue:work: опция --daemon
    ▪ queue:work: опция --queue <очередь1>,<очередь2>
    ▪ queue:work: опция --sleep=0
    ▪ queue:work: посмотреть все доступные опции
    ▪ queue:work: особенность в том, что он загружает всё при старте

    ▪ Принципы работы: цепочку тиков запускает cron
    ▪ Принципы работы: Laravel scheduler запускает задачу-старёр
    ▪ Принципы работы: как задача-стартёр проверяет, не прервалась ли цепочка тиков
    ▪ Принципы работы: задача-звено, или что значит запустить цепочку тиков

    ▪ Потенциальные проблемы: ждать до ~1 минуты восстановления цепочки тиков
    ▪ Потенциальные проблемы: не ровная периодичность тиков

    ▪ Бенчмаркинг: время вызова С3_tick из C2_link
    ▪ Бенчмаркинг: время выполнения C2_link, от начала до цикла while

  ---

  # Тики: что это такое?
    - Это происходящие каждую секунду события.
    - Эти события происходят в системе событий Laravel.
    - На эти события можно подписать любые обработчики.

  # Тики: как часто могут тикать?
    - Ограничение в меньшую сторону можно установить лишь опытным путём.
    - Также, я уверен, это зависит от мощности сервера.
    - Мне кажется, что хотя бы кажду секунду можно тикать на среднем сервере.

  # Тики: зачем нужны?
    - На тики можно подписывать любые обработчики событий.
    - При каждом тике эти обработчики будут срабатывать.
    - Тики полезны, когда надо очень часть проверять положение вещей где-то.
    - Например, организовывать таймеры, управляемые полностью с сервера,
      и транслировать время этих таймеров через websocket всех подписанным
      клиентам.

  # Скорость и надёжность: демон queue:work
    - Обрабатывать инициируемые тиками команды будет демон queue:work.
    - Единожды запустив приложение и фреймворк, он так и продолжает работать.
    - То есть, ему не надо при каждом запросе заново грузить весь фреймворк,
      а лишь на загруженном фрейворке выполнить соответствующую команду.

  # Скорость и надёжность: очередь задач "tick"
    - Демон queue:work будет обслуживать лишь 1-ну очередь задач "tick".

  # Скорость и надёжность: используется supervisor
    - Для поддержания queue:work работоспособным используется supervisor.
    - В случае краша queue:work supervisor исправит ситуацию.

  # queue:work: опция --daemon
    - При настройке queue:work в конфиге supervisor надо указать опцию --daemon
    - Иначе queue:work выполнится, и завершит работу.
    - А опция --daemon позволяет сделать queue:work демоном.

  # queue:work: опция --queue <очередь1>,<очередь2>
    - При настройке queue:work в конфиге supervisor надо указать опцию --queue
    - В ней указанть одну очередь: "tick".

  # queue:work: опция --sleep=0
    - Эта опция регулирует время ожидания демона перед опросом очереди
      на предмет новых задач.
    - Пока в очереди не 0 задач, демон не "засыпает".
    - Но когда становится 0, он засыпает на --sleep секунд.
    - И только по истечении этого времени снова опрашивает очередь.
    - Необходимо указать --sleep=0.

  # queue:work: посмотреть все доступные опции
    - Посмотреть все доступные для queue:work опции можно вот так:

        artisan help queue:work

  # queue:work: особенность в том, что он загружает всё при старте
    - Например, запустил ты свой Docker-проект.
    - После этого изменил какие-то команды, конфиги и т.д.
    - Однако, экземпляр laravel в queue:work имеет те версии этих команд
      и конфигов, которые были при старте.
    - Чтобы это дело обновить, надо перезагрузить Docker-проект.
    - Однако, этим можно управлять, например, через Redis.

  # Принципы работы: цепочку тиков запускает cron
    - А именно, Laravel scheduler, срабатывающий по cron'у ежеминутно.

  # Принципы работы: Laravel scheduler запускает задачу-старёр
    - Она проверяет, не прервалась ли цепочка тиков
    - И если прервалась, запускает цепочку тиков заново.

  # Принципы работы: как задача-стартёр проверяет, не прервалась ли цепочка тиков
    - Она в течение заданного в конфиге времени "слушает" тики.
    - Если хоть 1 тик будет, значит цепочка тиков жива, а если нет - значит мертва.

  # Принципы работы: задача-звено, или что значит запустить цепочку тиков
    - Задача-стартёр запускает 1-ну задачу-звено.
    - Она делает всего 3 вещи:

      • Сохраняет в Redis данные о текущем и предыдущем тике

      • Транслирует эти данные через систему событий Laravel
        - Посылая события в очередь по имени "tick".
        - С которой работает демон queue:work.

      • По прошествии N секунд выполняет саму себя
        - Значение N должно быть указано в конфиге, и м.б. менее 1 секунды.
        - Задача-звено должно свериться со временем запуска предыдущего своего экземпляра.
        - И на основании этого, в конце себя, запустить саму себя снова.

  # Потенциальные проблемы: ждать до ~1 минуты восстановления цепочки тиков
    - Если произошёл краш queue:work, то supervisor его восстановит.
    - Однако, следующего пинка от cron возможно придётся ждать до 1 минуты.
    - Плюс ждать, пока задача-стартер поймёт, что цепочка легла (по умолчанию
      10 секунд, но точно указано в конфиге).

  # Потенциальные проблемы: не ровная периодичность тиков
    - Тики могут идти не ровно каждые N секунд, как указано в конфиге.
    - Это может происходить по различным причинам:

      ▪ Время выполнения задачи-звена превышает указанный в конфиге период
        - Надо либо повысить мощность сервера, либо увеличить период.

      ▪ Система событий Laravel вносит свой вклад в задержку

      ▪ Система обработки команд Laravel вносит свой вклад в задержку

  # Бенчмаркинг: время вызова С3_tick из C2_link
    - Составляет в районе 30мс.

  # Бенчмаркинг: время выполнения C2_link, от начала до цикла while
    - В районе 60мс.
    - Потом начинается цикл while, в котором через ticks_period_ms
      (указанный в конфиге) после начала C2_link, она должна выполнить
      сама себя повторно.
    - То есть, ticks_period_ms лучше не ставить менее 100мс.















1. queue:work выполняет команды в очереди без перезагрузки фреймворка, что даёт существенный прирост производительности. Запускать его нужно через supervisor.

Посмотреть все доступные для queue:work опции можно вот так:
artisan help queue:work

Среди них есть и опция --queue, позволяющая указать очередь или очереди, которые будет обслуживать конкретный демон.

Также надо не забыть указать опция --daemon, и также опцию --sleep=0 (поскольку по умолчанию она равна 3)

2. Система из 2-х artisan команд
2.1. Первая запускается с помощью scheduler каждую минуту. Она проверяет, не прервалась ли цепочка тиков. Если нет, то ничего не делает.
2.2. Цепочка тиков. Запускается командой 2.1.  Она делает всего 3 вещи:
    1] Сохраняет в Redis данные о последнем (текущем тике).
    2] Транслирует эти данные через систему событий Laravel.
    3] Ровно через 1 секунду после предыдущего срабатывания (подсматривается также в Redis), запускает саму себя, и завершает работу.
2.3. Низкая нагрузка на процессор обеспечивается тем, что команды обрабатываются демоном queue:work, который производит обработку без преезагрузки фреймворка (то есть быстро).

3. Потенциальные проблемы
3.1. Ждать до 1 минуты для восстановления тиков в случае падения.
3.2. Тики будут не ровно каждую секунду, а с временными лагами. Придётся как-то настраивать систему, чтобы приблизить тики к идеалу.





```
## Функционал <a id="link98"></a>
```

  # Команды и к.команды общего назначения #
  #---------------------------------------#

    Команда                 К.Команда                   Описание
    ----------------------------------------------------------------------------------------------------------------------
    command                 | m1:command                | Description of the command


```
## Схемы взаимодействий с другими пакетами <a id="link99"></a>
```

  # Pull-взаимодействия (по инициативе этого пакета) #
  #--------------------------------------------------#

    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------

      -

  # Push-взаимодействия (по инициативе других пакетов) #
  #----------------------------------------------------#

    ---------------------------------------------------------------------------------------------
    Пакет     Команда     К.Команда     Обработчик      Событие           Комментарий
    ---------------------------------------------------------------------------------------------

      -


```
## Заметки к релизам <a id="link100"></a>
```

  1.0.0
    - Первый релиз.

```










